<%- include('../partials/admin_header') %>

<div class="container py-4">
  <h1>Leistungsseiten-Import</h1>
  <p class="text-muted">
    Lade eine JSON-Datei oder füge JSON direkt ein.
    Es wird in die Tabelle <code>leistungen_pages</code> importiert (UPSERT via <code>slug</code>).
  </p>

  <div class="row g-4">
    <div class="col-lg-6">
      <h5>Drag &amp; Drop / Datei wählen</h5>
      <div id="dropZone" class="border rounded p-4 text-center" style="border-style:dashed">
        <p class="mb-2">Datei hierher ziehen</p>
        <p class="small text-muted">oder</p>
        <input id="fileInput" type="file" accept=".json,application/json" class="form-control" />
      </div>

      <div class="mt-3 d-flex gap-2">
        <button id="btnPreview" class="btn btn-outline-secondary" disabled>Vorschau</button>
        <button id="btnImport" class="btn btn-primary" disabled>Import starten</button>
      </div>

      <!-- Fallback ohne JS -->
      <form class="mt-3" method="post" action="/admin/leistungen-pages/import/file" enctype="multipart/form-data">
        <div class="d-flex align-items-center gap-2">
          <input name="file" type="file" accept=".json,application/json" class="form-control" />
          <button class="btn btn-outline-primary">Fallback Upload</button>
        </div>
        <small class="text-muted">
          Erwartet z.B. <code>{ "page": { ... } }</code> oder
          <code>{ "items": [ { "page": { ... } }, ... ] }</code>.
        </small>
      </form>
    </div>

    <div class="col-lg-6">
      <h5>JSON einfügen</h5>
      <textarea id="jsonArea" class="form-control" rows="16" placeholder='{
  "page": {
    "slug": "rechtliches-sicherheit",
    "title": "Rechtliches, Sicherheit & Vertrauen",
    "hero": { "title": "...", "subtitle": "...", "icons": [ ... ] },
    "intro": { "problem": { ... }, "solution": { ... } },
    "services": [ ... ],
    "risks": { ... },
    "cta": { ... }
  }
}'></textarea>
      <div class="small mt-1" id="jsonStatus"></div>
    </div>
  </div>

  <hr class="my-4">

  <div>
    <h5>Vorschau</h5>
    <pre id="preview" class="bg-light p-3 rounded" style="max-height:360px; overflow:auto"></pre>
    <div id="importResult"></div>
  </div>
</div>

<script>
  // Minimal JS, falls du kein globales admin_import.js nutzt.
  (function() {
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const jsonArea = document.getElementById('jsonArea');
    const jsonStatus = document.getElementById('jsonStatus');
    const preview = document.getElementById('preview');
    const btnPreview = document.getElementById('btnPreview');
    const btnImport = document.getElementById('btnImport');

    let currentData = null;

    function setButtonsEnabled(enabled) {
      btnPreview.disabled = !enabled;
      btnImport.disabled = !enabled;
    }

    function parseText(text) {
      try {
        const data = JSON.parse(text);
        jsonStatus.textContent = '✔ JSON gültig';
        jsonStatus.className = 'small text-success';
        currentData = data;
        setButtonsEnabled(true);
      } catch (e) {
        jsonStatus.textContent = '✖ Ungültiges JSON: ' + e.message;
        jsonStatus.className = 'small text-danger';
        currentData = null;
        setButtonsEnabled(false);
      }
    }

    jsonArea.addEventListener('input', () => {
      const val = jsonArea.value.trim();
      if (!val) {
        jsonStatus.textContent = '';
        currentData = null;
        setButtonsEnabled(false);
        preview.textContent = '';
        return;
      }
      parseText(val);
    });

    // Drag & Drop
    if (dropZone) {
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('bg-light');
      });
      dropZone.addEventListener('dragleave', e => {
        e.preventDefault();
        dropZone.classList.remove('bg-light');
      });
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('bg-light');
        const file = e.dataTransfer.files[0];
        if (!file) return;
        if (!file.type.includes('json')) {
          alert('Bitte eine JSON-Datei hochladen.');
          return;
        }
        file.text().then(t => {
          jsonArea.value = t;
          parseText(t);
        });
      });
    }

    if (fileInput) {
      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.type.includes('json')) {
          alert('Bitte eine JSON-Datei hochladen.');
          return;
        }
        file.text().then(t => {
          jsonArea.value = t;
          parseText(t);
        });
      });
    }

    btnPreview.addEventListener('click', () => {
      if (!currentData) return;
      preview.textContent = JSON.stringify(currentData, null, 2);
    });

    btnImport.addEventListener('click', async () => {
      if (!currentData) return;
      preview.textContent = 'Import läuft...';

      const payload = Array.isArray(currentData) || currentData.items || currentData.page
        ? currentData
        : { items: [currentData] };

      const res = await fetch('/admin/leistungen-pages/import/json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      const box = document.getElementById('importResult');
      if (!result.ok) {
        box.innerHTML = `<div class="alert alert-danger">Fehler: ${result.error || 'Unbekannt'}</div>`;
        preview.textContent = '';
        return;
      }

      const rows = (result.results || [])
        .map(r => `${r.slug} – ${r.title || ''} – ${r.action}`)
        .join('\n');

      box.innerHTML = `<div class="alert alert-success">
        ${result.count} Einträge importiert.<br>
        <pre class="mb-0">${rows}</pre>
      </div>`;
      preview.textContent = '';
    });
  })();
</script>

<%- include('../partials/admin_footer') %>
