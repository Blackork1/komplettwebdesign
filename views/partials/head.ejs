<!DOCTYPE html>
<html lang="de">

<head>
  <%
  const pageTitle = title || 'Komplett Webdesign | Website erstellen lassen in Berlin';
  const pageDescription = description || 'Professionelles Webdesign in Berlin: Website erstellen lassen mit Fokus auf Sichtbarkeit, Performance und Anfragen.';
  const seoExtraText = typeof seoExtra === 'string' ? seoExtra : '';
  const hasCanonical = /rel=["']canonical["']/i.test(seoExtraText);
  const hasOgTitle = /property=["']og:title["']/i.test(seoExtraText);
  const hasOgDescription = /property=["']og:description["']/i.test(seoExtraText);
  const hasOgUrl = /property=["']og:url["']/i.test(seoExtraText);
  const hasOgImage = /property=["']og:image["']/i.test(seoExtraText);
  const hasOgType = /property=["']og:type["']/i.test(seoExtraText);
  const hasTwitterCard = /name=["']twitter:card["']/i.test(seoExtraText);
  const siteBase = (canonicalBaseUrl || 'https://www.komplettwebdesign.de').replace(/\/$/, '');
  const pageCanonical = canonicalUrl || `${siteBase}/`;
  const defaultOgImage = (typeof ogImage === 'string' && ogImage.trim())
    ? ogImage.trim()
    : `${siteBase}/images/heroBg.webp`;
  const assetV = encodeURIComponent(assetVersion || '1');
  const versionSuffix = `?v=${assetV}`;
  %>
  <meta charset="UTF-8" />
  <title><%= pageTitle %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="<%= pageDescription %>" />
  <meta name="robots" content="<%= robots || 'index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1' %>" />
  <% if (typeof keywords === 'string' && keywords.trim()) { %>
  <meta name="keywords" content="<%= keywords %>" />
  <% } %>
  <% if (!hasCanonical) { %>
  <link rel="canonical" href="<%= pageCanonical %>" />
  <% } %>
  <% if (!hasOgType) { %>
  <meta property="og:type" content="website" />
  <% } %>
  <% if (!hasOgTitle) { %>
  <meta property="og:title" content="<%= pageTitle %>" />
  <% } %>
  <% if (!hasOgDescription) { %>
  <meta property="og:description" content="<%= pageDescription %>" />
  <% } %>
  <% if (!hasOgUrl) { %>
  <meta property="og:url" content="<%= pageCanonical %>" />
  <% } %>
  <% if (!hasOgImage) { %>
  <meta property="og:image" content="<%= defaultOgImage %>" />
  <% } %>
  <% if (!hasTwitterCard) { %>
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="<%= pageTitle %>" />
  <meta name="twitter:description" content="<%= pageDescription %>" />
  <meta name="twitter:image" content="<%= defaultOgImage %>" />
  <% } %>

  <!-- Fonts / CSS (wie bei dir) -->
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin />
  <link rel="preload" href="/assets/css/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin />

  <link rel="preload" href="/assets/css/fontawesome.min.css" as="style" onload="this.rel='stylesheet'" />
  <noscript>
    <link rel="stylesheet" href="/assets/css/fontawesome.min.css" />
  </noscript>

  <link rel="preload" href="/assets/css/solid.min.css" as="style" onload="this.rel='stylesheet'" />
  <noscript>
    <link rel="stylesheet" href="/assets/css/solid.min.css" />
  </noscript>

  <link rel="preload" href="/fonts/inter-v19-latin-600.woff2" as="font" type="font/woff2" crossorigin />
  <link rel="preload" href="/fonts/inter-v19-latin-regular.woff2" as="font" type="font/woff2" crossorigin />
  <link rel="preload" href="/fonts/poppins-v23-latin-700.woff2" as="font" type="font/woff2" crossorigin />
  <link rel="preload" href="/fonts/poppins-v23-latin-regular.woff2" as="font" type="font/woff2" crossorigin />

  <link rel="preload" href="/css/bootstrap.min.css" as="style" />
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <link rel="preload" href="/css/main.min.css<%= versionSuffix %>" as="style" />
  <link rel="stylesheet" href="/css/main.min.css<%= versionSuffix %>" />

  <link rel="preload" href="/extra.css<%= versionSuffix %>" as="style" onload="this.rel='stylesheet'" />
  <noscript>
    <link rel="stylesheet" href="/extra.css<%= versionSuffix %>" />
  </noscript>

  <link rel="preload" href="/booking-widget.css<%= versionSuffix %>" as="style" onload="this.rel='stylesheet'" />
  <noscript>
    <link rel="stylesheet" href="/booking-widget.css<%= versionSuffix %>" />
  </noscript>

  <!-- Stripe lazy loader (wie bei dir) -->
  <script>
    window.ensureStripe = function(pk) {
      return new Promise(resolve => {
        if (window.Stripe) return resolve(window.Stripe(pk));
        const s = document.createElement('script');
        s.src = "https://js.stripe.com/v3/";
        s.async = true;
        s.onload = () => resolve(window.Stripe(pk));
        document.head.appendChild(s);
      });
    };

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-open-checkout]');
      if (!btn) return;
      e.preventDefault();
      const stripe = await window.ensureStripe("<%= process.env.STRIPE_PUBLISHABLE_KEY %>");
      // await stripe.redirectToCheckout({ sessionId: '...' });
    }, {
      passive: false
    });
  </script>

  <!-- Favicon / Manifest -->
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/images/icon192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon180.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <% if (locals.seoExtra) { %>
  <%- typeof seoExtra === 'string' ? seoExtra : '' %>
  <% } %>

  <!-- =========================================================
       DSGVO-SICHER / BASIC CONSENT MODE
       - Default denied VOR jeglichem Google-Script
       - GA & Clarity werden erst nach Einwilligung geladen
       - KEINE Auto-Pageviews im Head
       ========================================================= -->
  <script>
    // globale IDs für clientseitige Scripts
    window.env = {
      GA_MEASUREMENT_ID: "<%= process.env.GA_MEASUREMENT_ID %>",
      CLARITY_ID: "<%= process.env.CLARITY_ID %>"
    };

    // Consent Mode Defaults (alles denied)
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('consent', 'default', {
      analytics_storage: 'denied',
      ad_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      wait_for_update: 500
    });

    // --------- GA Loader (wird NUR nach Consent aufgerufen) ---------
    function loadGA() {
      if (window.__gaLoaded) return;
      window.__gaLoaded = true;

      var s = document.createElement('script');
      s.async = true;
      s.src = "https://www.googletagmanager.com/gtag/js?id=<%= process.env.GA_MEASUREMENT_ID %>";
      document.head.appendChild(s);

      s.onload = function() {
        gtag('js', new Date());
        gtag('config', "<%= process.env.GA_MEASUREMENT_ID %>", {
          send_page_view: false, // PV kommt erst per cookie-consent.js
          allow_google_signals: false // wird dort je nach marketing gesetzt
        });
      };
    }

    // Hook für dein Banner:
    // cookie-consent.js ruft bei Analytics-Einwilligung updateAnalyticsConsent(true) auf
    window.updateAnalyticsConsent = function(granted) {
      gtag('consent', 'update', {
        analytics_storage: granted ? 'granted' : 'denied'
      });
      if (granted) loadGA();
    };

    // --------- Clarity Loader (nur nach Consent) ---------
    window.loadClarity = function() {
      var id = window.env && window.env.CLARITY_ID;
      if (!id) return;
      if (window.clarity) return;
      if (document.querySelector('script[src*="clarity.ms/tag/"]')) return;

      (function(c, l, a, r, i, t, y) {
        c[a] = c[a] || function() {
          (c[a].q = c[a].q || []).push(arguments)
        };
        t = l.createElement(r);
        t.async = 1;
        t.src = "https://www.clarity.ms/tag/" + id;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, "clarity", "script");

      (function tryConsent() {
        if (typeof window.clarity === 'function') {
          try {
            window.clarity('consent', true);
          } catch (e) {}
        } else setTimeout(tryConsent, 200);
      })();
    };
  </script>
</head>
